\documentclass[a4paper, 14pt]{extarticle}
\usepackage[utf8]{inputenc}
\usepackage[english, russian]{babel}
\usepackage[left=30mm, top=15mm, right=10mm, bottom=20mm, head=0mm, nofoot]{geometry}
\usepackage{amsmath, amssymb}
\usepackage{fontspec}
\usepackage{hyperref}

\usepackage{graphicx}
\graphicspath{{img/}}
\DeclareGraphicsExtensions{.png}

\usepackage{pstricks}

\defaultfontfeatures{Ligatures={TeX}, Renderer=Basic}
\setmainfont[Ligatures={TeX, Historic}]{Times New Roman}

\linespread{1.3}
\setlength{\parindent}{1.25cm}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}

\begin{document}
	\input{title_page/title_page.tex}
	
	\newpage
	\setcounter{page}{2}
	\textbf{Введение}
	
	В условиях пандемии учебные заведения ощутили нехватку программного обеспечения,
	направленного на проведение онлайн-занятий. Обычно такие занятия проводятся с
	применением системы программ: какой-либо мессенджер с чатом, поддержкой голосовой
	связи и демонстрации экрана, и вместе с ним инструмент, удобный для проведения
	занятия -- к примеру, интерактивная доска. Было бы намного удобнее, чтобы все это
	располагалось в одной программе. Именно так возникла идея создания
	проекта <<Geometry Room>>: создать единый сервис для проведения онлайн-занятий.
	Так как объединить все инструменты для всех предметов, преподаваемых в
	учебных заведениях, просто невозможно, было принято решение взять одну
	из самых сложных сфер предметов с точки зрения онлайн-преподавания -- геометрию.
	
	\hfill \break
	
	\textbf{Цель и этапы}
	
	Цель проекта: создать удобный веб-сервис для проведения онлайн-занятий
	по геометрии.
	
	Эта цель предполагает создание клиент-серверного приложения, исходя из
	этого можно выделить 3 этапа:
	
	\noindent
	1. Создать основу http-сервера (back-end) на \emph{Node.js}
	с помощью фреймворка \emph{Express}.
	
	\noindent
	2. Создать веб-интерфейс (front-end) с использованием гибкого
	шаблонизатора \emph{handlebars}.
	
	\noindent
	3. Объединить front-end и back-end системой сокетов с помощью библиотеки
	\emph{socket.io}.
	
	\hfill \break
	
	\textbf{Этап 1. Создание сервера}
	
	В качестве основы сервера  была выбрана платформа \emph{Node.js}
	и фреймворк \emph{Express}. Такая комбинация обеспечивает достаточно стабильную
	и быструю работу.
	
	После выбора платформы встал вопрос о концепции совместного доступа.
	Это вопрос об одном меле и двух учениках: одновременно пользоваться
	мелом не получится, только поочередно передавая его друг другу.
	Остается решить, как этот мел будет передаваться между учениками.
	Появляются два варианта: ученики будут отбирать мел друг у друга,
	или же спрашивать учителя: кто в данный момент должен писать.
	Возникает очевидный вопрос: <<почему мел один?>>. Предположим,
	что два человека попытаются на одной доске переместить одну и ту же
	точку в разные места. В таком случае эта точка раздвоится, чего не может быть.
	Тем самым появляется простое решение -- система комнат с двумя типами прав:
	ограниченные и свободные (restricted и free).
	
	Ограниченная система прав (Рис.~\ref{fig:img1}) предполагает обязательное наличие владельца комнаты
	и согласование с ним всех действий. Можно привести пример учитель-ученики:
	учитель объясняет тему, после этого дает задание: построить фигуру;
	ученик, желающий это сделать, запрашивает доступ (права) на редактирование
	доски и соответственно это видит учитель и разрешает доступ.
	При этом владелец комнаты всегда может отобрать права на редактирование
	доски у любого ученика.
	
	\begin{figure}[h]
		\begin{center}
			\scalebox{0.6}{\input{Inkscape/Inkscape_img1.tex}}
			\caption{Ограниченная система прав}
			\label{fig:img1}
		\end{center}
	\end{figure}
	
	Свободная система прав (Рис.~\ref{fig:img2}) не предполагает наличие владельца комнаты,
	каждый участник может забрать права на редактирование доски без
	согласования с другими участниками. Пример: два преподавателя обсуждают
	какую-нибудь схему на доске и вместе ее дополняют; в этом случае было бы
	неудобно чтобы каждый раз один из преподавателей <<разрешал>> другому
	редактировать доску как в ограниченной системе прав.
	
	\begin{figure}[h]
		\begin{center}
			\scalebox{0.6}{\input{Inkscape/Inkscape_img2.tex}}
			\caption{Свободная система прав}
			\label{fig:img2}
		\end{center}
	\end{figure}
	
	Следующим шагом стало создание базы данных для хранения комнат.
	Это связано с тем, чтобы после выхода всех участников из комнаты была
	возможность вернуться в эту комнату и не потерять всю историю действий.
	Было рассмотрено несколько библиотечных баз данных, взаимодействующих
	с платформой \emph{Node.js}, но все они оказались слишком тяжелыми
	для такой простой задачи. Пример: БД \emph{MySQL} требует отдельный
	сервер для работы и большое количество оперативной памяти, что
	является недопустимым для проекта, т.к. он должен иметь возможность
	работать на маломощном сервере. Поэтому решено было написать собственную
	базу данных.
	
	Структура базы данных представляла систему, состоящую из двух блоков.
	Первый блок должен был выполнять функцию хранения данных на локальном
	диске с помощью \emph{json}-файлов. Второй блок хранил данные в
	оперативной памяти. Взаимодействуют они следующим образом: пока
	в комнате есть участники -- данные комнаты хранятся в оперативной
	памяти для быстрого доступа к ним. Как только все участники покидают
	комнату -- данные записываются на локальный диск в \emph{json}-файл и
	освобождаются из оперативной памяти. Соответственно, если в пустую комнату
	заходит хотя бы один участник -- данные этой комнаты считываются с
	\emph{json}-файла и помещаются в оперативную память.
	
	\hfill \break
	
	\textbf{Этап 2. Создание веб-интерфейса}
	
	В первую очередь стоит поговорить об инструменте для работы
	с геометрией. Выбор пал на один из самых популярных, стандарт
	в этой сфере -- платформа \emph{GeoGebra}.
	В ней есть множество различных функций для работы с геометрическими
	фигурами. Этим не могут похвастаться различные многопользовательские
	онлайн-доски (хоть и в большинстве случаев им это просто не нужно).
	
	К примеру: в прошлом году на математическом факультете дистанционные занятия
	по аналитической геометрии успешно проводились с использованием
	\emph{GeoGebra}, только транслировалась она через сторонний мессенджер,
	используя демонстрацию экрана.
	
	В проекте использовались веб-элементы \emph{GeoGebra},
	а именно апплеты. На официальном сайте в документации подробно,
	хотя местами довольно сложно, описано API апплетов. Оно позволяет
	развернуть на странице браузера стандартную версию \emph{GeoGebra}
	и манипулировать ее состоянием и элементами средствами языка
	\emph{JavaScript}.
	
	Следующая задача: создать схему интерфейса (Рис.~\ref{fig:img3}).
	
	\begin{figure}[h]
		\begin{center}
			\scalebox{0.6}{\input{Inkscape/Inkscape_img3.tex}}
			\caption{Общая схема клиентской части}
			\label{fig:img3}
		\end{center}
	\end{figure}
	
	Для удобства было решено разделить страницу на три части (Рис.~\ref{img1}). В первой части (левой)
	располагается основная информация комнаты, панель управления правами и список участников.
	Вторая часть (центральная) содержит апплет \emph{GeoGebra}.
	В третьей части (правой) был размещен чат. При этом, для экономии места,
	левую и правую части можно свернуть. Когда они свернуты пользователь
	может отследить активность чата и, если используется комната с
	ограниченными правами, запрос на предоставление прав. Отслеживание
	выполняется путем мигания боковых вертикальных кнопок (с помощью которых
	и сворачиваются элементы).
	
	\begin{figure}[h]
		\begin{center}
			\includegraphics[width=\linewidth]{img1}
			\caption{Веб-интерфейс}
			\label{img1}
		\end{center}
	\end{figure}
	
	В комнате с ограниченными правами, если пользователь запрашивает доступ
	с помощью специальной кнопки, то приходит уведомление владельцу и в
	списке участников комнаты, напротив имени пользователя, запросившего
	права, появляются две кнопки $+$ и $-$, нажимая первую, владелец передает
	право редактировать доску, соответственно, нажимая вторую, он отказывает
	в доступе.
	
	Нeмaлoвaжной функцией является трансляция курсора мыши пользователя,
	который в данный момент имеет доступ для редактирования доски. Эта
	функция включается соответствующей кнопкой в левой панели.
	
	Еще одной функцией является трансляция координат. Функция позволяет
	полностью синхронизировать перемещение координат апплета \emph{GeoGebra},
	включается она так же соответствующей кнопкой в левой панели.
	Эта функция не была включена по умолчанию, т.е. активируется
	только кнопкой, т.к. в некоторых случаях она мешает просмотру.
	
	
	Все элементы интерфейса были написаны с использованием
	шаблонизатора \emph{handlebars}. Он обеспечивает более гибкую
	компоновку элементов веб-страниц.
	
	Стоит отметить важность набора формул в чате, поэтому, используя библиотеку
	\emph{KaTeX}, была добавлена поддержка синтаксиса \emph{LaTeX}.
	Т.е. каждое сообщение, которое приходит пользователю проверяется
	библиотекой на наличие специальных символов, в которых помещается
	выражение.
	
	Также для эффективного использования экранного места был
	добавлен полноэкранный режим с помощью стандартных средств
	языка \emph{JavaScript}.
	
	Кроме основной страницы комнаты есть и вспомогательные. Они
	обеспечивают простую и удобную систему входа в нее: окно приветствия,
	окно создания комнаты, окно выбора типа прав и окно входа в комнату.
	
	Вход в определенную комнату осуществляется с помощью сгенерированной
	пары ключей (Рис.~\ref{img2}): ключ комнаты (номер комнаты) и ключ владельца,
	последний нужен для работы
	ограниченной системы прав. Эти ключи передаются на сервер, и он уже
	отправляет пользователя в искомую комнату.
	Данные ключи можно скопировать, нажав на соответствующую кнопку
	при создании комнаты или, если комната уже создана, скопировать
	только ключ комнаты через кнопку в левой панели.
	
	\begin{figure}[h]
		\begin{center}
			\includegraphics[width=\linewidth]{img2}
			\caption{Интерфейс подключения к комнате}
			\label{img2}
		\end{center}
	\end{figure}
	
	\textbf{Этап 3. Система сокетов}
	
	Для работы с сокетами была использована библиотека \emph{socket.io},
	которая хорошо совместима с \emph{Node.js}.
	
	В проекте сокеты необходимы для взаимодействия веб-интерфейса с
	сервером (Рис.~\ref{fig:img4}), помимо основной маршрутизации \emph{Express}.
	
	\begin{figure}[h]
		\begin{center}
			\scalebox{0.6}{\input{Inkscape/Inkscape_img4.tex}}
			\caption{Схема клиент-серверного приложения}
			\label{fig:img4}
		\end{center}
	\end{figure}
	
	Первоочередная задача -- создание инструкций передачи данных
	апплета \emph{GeoGebra} как на сервер, так и из него. В базовом API апплета
	предусмотрено несколько вариантов сохранения/загрузки данных,
	в том числе с помощью \emph{json}-файлов и \emph{XML}-файлов.
	Опытным путем был выбран вариант работы с \emph{XML}-файлами,
	т.к. они оказались удобнее. Соответственно была написана
	функция передачи/приема \emph{XML}-файлов с помощью сокетов.
	Тем самым мы получили возможность многопользовательской работы
	с апплетом \emph{GeoGebra}.
	
	Рассмотрим работу инструкций по этапам на примере:
	
	1. Пользователь, владеющий правами на редактирование доски,
	добавляет точку в координатную плоскость апплета.
	
	2. В API апплета есть обработчики событий, которые реагируют
	на изменение состояния апплета, в нашем случае была добавлена точка,
	и вызывают функцию сохранения/передачи.
	
	3. Функция сохранения/передачи копирует \emph{XML}-код
	апплета и, если есть возможность, редактирует его (об этом ниже).
	После этого через сокет отправляет этот код на сервер вместе с
	номером комнаты.
	
	4. Сервер принимает данные из сокета, т.е. \emph{XML}-код и номер
	комнаты. Далее по номеру комнаты ищет всех ее участников и отправляет
	им через сокет полученный \emph{XML}-код.
	
	5. Участники через сокет получают \emph{XML}-код от сервера.
	Вызывается функция загрузки \emph{XML}-кода в апплет.
	
	Причем перед отправкой любых данных через сокеты, сервер проверяет
	id пользователя, его принадлежность к комнате, и наличие у него прав
	владельца комнаты (для комнаты с ограниченными правами). Тем самым
	отсеивая любую возможность взаимодействия участников одной комнаты с другой.
	
	Таким образом происходит синхронизация \emph{XML}-кода апплета
	пользователя с правами на редактирование доски с другими участниками
	комнаты.
	
	Стоит отметить, что был проведен анализ, какие элементы в
	\emph{XML}-коде постоянны, а какие изменяются. Исходя
	из этого, для уменьшения нагрузки на сеть, \emph{XML}-код
	перед отправкой обрезается и в нем остаются только изменяющиеся
	элементы.
	
	Координаты плоскости апплета так же входят в \emph{XML}-код,
	соответственно функция трансляции координат
	(о которой говорилось выше в этапе 2) отключается путем той самой обрезки
	части \emph{XML}-кода, если данная функция включена, то эта часть с 
	координатами остается и передается вместе с остальным \emph{XML}-кодом.
	
	Следующая задача - инструкции для передачи команд управления правами
	и работы чата. Это достаточно тривиальная задача, т.к. в ней требуется
	передавать через сокеты малый объем информации.
	
	Инструкции для передачи команд управления правами работают просто.
	Рассмотрим пример. Пользователь запрашивает права у владельца, нажимая
	соответствующую кнопку. Обработчик клика этой кнопки вызывает
	функцию, которая через сокет передает номер комнаты, специальный
	id участника и команду для запроса прав. Сервер принимает данные
	сокета, по номеру комнаты ищет владельца и отправляет через сокет
	id участника, запросившего права. Владелец получает уведомление
	и принимает решение: передать права или нет. Это решение (true или false)
	отправляется на сервер через сокет вместе с номером комнаты и id участника.
	Сервер рассматривает решение владельца, и в соответствии с ним
	либо отдает права участнику, либо нет, отправляя ему соответствующее
	уведомление через сокет. В свободной системе прав все происходит
	намного проще, но общая схема остается такой же.
	
	В комнате с ограниченной системой прав, если участник отказывается
	от права редактирования доски (повторно нажимая кнопку, которой он запрашивал
	права), то права на редактирование немедленно возвращаются владельцу
	комнаты.
	
	В комнате со свободной системой прав, если участник отказывается от прав
	на редактирование доски, то права никому не передаются, пока их не
	запросит другой пользователь.
	
	Инструкции работы чата оказались самой простой задачей, т.к. в документации
	\emph{socket.io} много информации об этом.
	Снова рассмотрим пример. В случае чата нет никакой разницы,
	какая система прав используется. Участник пишет сообщение, нажимает
	кнопку, на которой размещен обработчик клика. Обработчик вызывает
	функцию, которая отправляет через сокет сообщение пользователя, 
	номер комнаты и имя пользователя на сервер. Сервер принимает все данные,
	по номеру комнаты ищет всех участников и через сокет отправляет
	это сообщение, соединенное с именем пользователя, всем участникам комнаты.
	Участники принимают это сообщение, оно оборачивается в элемент списка
	и помещается в контейнер чата.
	
	Так же, через систему сокетов, связана и трансляция курсора мыши
	(о которой говорилось выше в этапе 2), только передаются уже
	координаты. Однако, в чистом виде, как они есть, передавать координаты
	нельзя, т.к. в этом случае существует привязка к разрешению экрана пользователя.
	Поэтому координаты преобразуются в доли от разрешения экрана.
	Пример: разрешение экрана пользователя 1920х1080, указатель
	расположен в точке по координатам (960, 540), т.е. в центре экрана;
	тем самым для отправки через сокеты мы преобразуем координаты в доли,
	получая точку ($\frac{960}{1920}, \frac{540}{1080}$), т.е.
	(0.5, 0.5). Когда другой пользователь получает такие координаты,
	то происходит обратное преобразование, но с учетом его разрешения.
	
	Помимо этого, для оптимизации, каждый сокет был связан с таймером,
	который ограничивает количество тиков передачи данных, тем
	самым уменьшая нагрузку как на сеть, так и на ПК пользователя.
	
	Напомним, что любое действие в комнате сохраняется в базе данных,
	в том числе \emph{XML}-код апплета и весь чат.
	
	\hfill \break
	
	\textbf{Перспективы дальнейшей разработки:}
	
	\noindent
	1. Добавление голосовой связи в комнаты
	(на данный момент она частично реализована, но требует отладки).
	
	\noindent
	2. Настройка масштабирования веб-страниц. На данный момент
	присутствую проблемы с масштабированием на разные разрешения экрана.
	
	\noindent
	3. Добавление мобильной версии.
	
	\noindent
	4. Добавление дополнительной интерактивной доски в качестве
	скрываемой верхней панели.
	
	\noindent
	5. Локализация на английский язык.
	
	\hfill \break

	\textbf{Исходный код:}
	
	\hfill \break
	
	Исходный код (Рис.~\ref{fig:img5}) расположен по ссылке на \emph{GitHub}:
	
	\begin{center}
		\url{https://github.com/aezv/geometryroom}
	\end{center}
	
	\hfill \break
	
	Рабочая версия для демонстрации расположена по ссылке:
	
	\begin{center}
		\url{https://geometryroom.herokuapp.com/}
	\end{center}

	\newpage
	\begin{figure}[h]
		\begin{center}
			\scalebox{1}{\input{Inkscape/Inkscape_img5.tex}}
			\caption{Структура (дерево) проекта}
			\label{fig:img5}
		\end{center}
	\end{figure}
\end{document}